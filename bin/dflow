#!/usr/bin/env node

process.title = 'dflow'

var fs   = require('fs'),
    nopt = require('nopt'),
    path = require('path')

var createEmptyGraph = require('../src/createEmptyGraph'),
    editorServer     = require('../src/editor/server')

// Process arguments.

var known = {
      help: Boolean,
      version: Boolean
    },
    aliases = {
      h: '--help',
      V: '--version'
    }

var command = process.argv[2]

var opt = nopt(known, aliases, process.argv, 2)

function appendCurrentWorkingDir (givenPath) {
  return path.join(process.cwd(), givenPath)
}

var graphPath = opt.argv.remain.map(appendCurrentWorkingDir).shift()

if (typeof graphPath === 'undefined') {
  graphPath = appendCurrentWorkingDir('graph.json')
}

function checkGraphPath (err, stats) {
  if (err && err.code === 'ENOENT') {
    createEmptyGraph(graphPath, editorServer.bind(null, graphPath, opt))
  }
  else {
    if (stats.isFile()) {
      editorServer(graphPath, opt)
    }
  }
}

fs.stat(graphPath, checkGraphPath)

