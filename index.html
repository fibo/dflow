<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:;base64,=">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, minimum-scale=1.0, maximum-scale=2.0" />

  <title>dflow</title>
  <meta name="description" content="is a minimal Dataflow programming engine">

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main>
    <h1>dflow</h1>

    <blockquote>is a minimal <em>Dataflow programming</em> engine</blockquote>

    <div class="container">
    </div>
  </main>

  <script type="module">
    import { FlowView } from 'https://unpkg.com/flow-view@5.4.0';
    import { catalog } from './dflow.js';

    const flowView = new FlowView({
      container: document.querySelector('.container')
    });

    const nodeLabels = Object.keys(catalog);

    flowView.addNodeLabels(nodeLabels);

    const initialGraph = {
      nodes: [
        {
          id: 'a',
          label: 'number',
          x: 60, y: 70,
          outputs: [ { id: 'ao1' } ]
        },
        {
          id: 'b',
          label: 'addition',
          x: 60, y: 240,
          inputs: [ { id: 'bi1' }, { id: 'bi2' } ],
          outputs: [ { id: 'bo1' } ]
        }
      ],
      edges: [
        { from: ['a', 'ao1'], to: ['b', 'bi1'] },
        { from: ['a', 'ao1'], to: ['b', 'bi2'] },
      ]
    };

    flowView.onChange(({ action, data }) => {
      switch(action) {
        case "CREATE_NODE": {
          const view = flowView.node(data.id);

          // Make it case insensitive.
          const label = nodeLabels.find((nodeLabel) => {
            return (nodeLabel.toLowerCase() === data.label.toLowerCase());
          }) || data.label;
          view.label = label;

          // Complete node inputs and outputs.
          if (nodeLabels.includes(label)) {
            const NodeClass = catalog[label];

            const { inputs = [], outputs = [] } = NodeClass

            for (let i = 0; i < inputs.length; i++) {
              const name = inputs[i].name;

              if (!view.inputs[i]) {
                view.newInput({});
              }

              if (typeof name === 'string') {
                view.inputs[i].name = name;
                view.inputs[i].text = name;
              }
            }

            for (let i = 0; i < outputs.length; i++) {
              const name = outputs[i].name;

              if (!view.outputs[i]) {
                view.newOutput({});
              }

              if (typeof name === 'string') {
                view.outputs[i].name = name;
                view.outputs[i].text = name;
              }
            }
          } else {
            try {
              const maybeJson = JSON.parse(label)

              if (view.outputs.length === 0) {
                view.newOutput({});
              }

              if (typeof maybeJson === 'number') {
                view.outputs[0].text = 'number';
              }

              if (typeof maybeJson === 'string') {
                view.outputs[0].text = 'string';
              }

              if (typeof maybeJson === 'object') {
                view.label = JSON.stringify(maybeJson);

                if (Array.isArray(maybeJson)) {
                  view.outputs[0].text = 'array';
                } else {
                  view.outputs[0].text = 'object';
                }
              }
            } catch (ignore) {}
          }
        }

        default: {
          console.log(action, data);
        }
      }
    })

    flowView.loadGraph(initialGraph);
  </script>

  <footer>
    GitHub: <a href="https://github.com/fibo/dflow">fibo/dflow</a>
  </footer>
</body>
</html>
