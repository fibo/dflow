<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:;base64,=">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>dflow</title>
  <meta name="description" content="is a minimal Dataflow programming engine">

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main>
    <h1>dflow</h1>

    <blockquote>is a minimal <em>Dataflow programming</em> engine</blockquote>

    <div class="container">
    </div>

    <div class="controls">
      <button id="run">Run</button>
      <button id="clear">Clear</button>
    </div>

    <div>
      <pre><code id="execution-report"></code></pre>
    </div>
  </main>

  <script type="module">
    import { FlowView } from 'https://unpkg.com/flow-view';
    import { DflowHost } from './dflow.js';
    import { nodesCatalog } from './nodes.js';

    const flowView = new FlowView({
      container: document.querySelector('.container')
    });

    const dflow = new DflowHost(nodesCatalog);
    const catalog = dflow.nodesCatalog;
    dflow.verbose = true;

    const nodeLabels = Object.keys(catalog);

    flowView.addNodeLabels(nodeLabels);

    const initialGraph = {
      nodes: [
        {
          id: 'a',
          label: '2',
          x: 60, y: 70,
          outputs: [ { id: 'ao1', types: ['number'], data: 2 } ]
        },
        {
          id: 'b',
          label: 'addition',
          x: 60, y: 240,
          inputs: [ { id: 'bi1' }, { id: 'bi2' } ],
          outputs: [ { id: 'bo1' } ]
        },
        {
          id: 'PI',
          label: 'mathPi',
          x: 170, y: 70,
          outputs: [ { id: 'pi' } ]
        }
      ],
      edges: [
        { from: ['a', 'ao1'], to: ['b', 'bi1'] },
        { from: ['a', 'ao1'], to: ['b', 'bi2'] },
      ]
    };

    flowView.onChange(({ action, data }) => {
      switch(action) {
        case "CREATE_NODE": {
          const nodeId = data.id;
          const view = flowView.node(nodeId);

          // Make it case insensitive.
          const label = nodeLabels.find((nodeLabel) => {
            return (nodeLabel.toLowerCase() === data.label.toLowerCase());
          }) || data.label;
          view.label = label;

          if (nodeLabels.includes(label)) {
            // Create node on dflow
            dflow.newNode({ kind: label, id: nodeId })

            // Complete node view with inputs and outputs.
            const NodeClass = catalog[label];

            const { inputs = [], outputs = [] } = NodeClass

            for (let i = 0; i < inputs.length; i++) {
              const name = inputs[i].name;

              if (!view.inputs[i]) {
                view.newInput({});
              }

              if (typeof name === 'string') {
                view.inputs[i].name = name;
                view.inputs[i].text = name;
              }
            }

            for (let i = 0; i < outputs.length; i++) {
              const name = outputs[i].name;

              if (!view.outputs[i]) {
                view.newOutput({});
              }

              if (typeof name === 'string') {
                view.outputs[i].name = name;
                view.outputs[i].text = name;
              }
            }
          } else {
            try {
              const maybeJson = JSON.parse(label);

              if (view.outputs.length === 0) {
                view.newOutput({});
              }

              const typeofMaybeJson = typeof maybeJson;

              if (['boolean', 'number', 'string'].includes(typeofMaybeJson)) {
                const node = dflow.newNode({
                  id: nodeId,
                  kind: catalog.data.kind,
                  outputs: [{ types: [typeofMaybeJson], data: maybeJson }]
                });

                view.outputs[0].text = typeofMaybeJson;
              }

              if (typeofMaybeJson === "object") {
                const dataType = Array.isArray(maybeJson)
                  ? "array"
                  : "object";
                dflow.newNode({
                  id: nodeId,
                  kind: "data",
                  outputs: [
                    {
                      types: [dataType],
                      data: maybeJson,
                    },
                  ],
                });

                view.outputs[0].text = dataType;
              }
            } catch (ignore) {}
          }

          break;
        }

        /*
        case 'CREATE_EDGE': {
          const {
            id,
            from: [sourceNodeId, sourcePinId],
            to: [targetNodeId, targetPinId],
          } = data

          dflow.newEdge({
            id,
            source: [sourceNodeId, sourcePinId],
            target: [targetNodeId, targetPinId],
          });
          break;
        }
          */

        default: {
          console.log(action, data);
        }
      }
    })

    flowView.loadGraph(initialGraph);

    // Controls

    const executionReport = document.querySelector('code#execution-report');

    const runButton = document.querySelector('button#run');
    runButton.addEventListener('click', () => {
      executionReport.innerHTML = ''

      dflow.run()

      executionReport.innerHTML = JSON.stringify(dflow.executionReport, null, 2)
    })

    const clearButton = document.querySelector('button#clear');
    clearButton.addEventListener('click', () => {
      flowView.clearGraph();
      dflow.clearGraph()
      executionReport.innerHTML = ''
    })
  </script>

  <footer>
    GitHub: <a href="https://github.com/fibo/dflow">fibo/dflow</a>
  </footer>
</body>
</html>
